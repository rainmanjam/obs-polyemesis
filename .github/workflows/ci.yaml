name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }} @ ${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # Stage 1: Lint and Format Checks (fastest, fail fast)
  lint:
    name: Lint & Code Quality
    uses: ./.github/workflows/lint.yaml

  # Stage 2: Build and Test (depends on lint)
  build-and-test:
    name: Build & Test
    needs: lint
    uses: ./.github/workflows/build-project.yaml

  # Stage 3: Security Scanning (depends on build)
  security:
    name: Security Scan
    needs: build-and-test
    uses: ./.github/workflows/security.yaml
    secrets: inherit

  # Stage 4: Code Quality Analysis (depends on build, runs in parallel with security)
  sonarcloud:
    name: SonarCloud Analysis
    needs: build-and-test
    uses: ./.github/workflows/sonarcloud.yaml
    secrets: inherit
