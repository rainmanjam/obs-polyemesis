name: Lint and Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  workflow_call:

jobs:
  format-check:
    name: Format Check (clang-format)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18

      - name: Check Code Formatting
        continue-on-error: true  # Allow formatting differences due to tool versions
        run: |
          find src tests -name '*.c' -o -name '*.cpp' -o -name '*.h' | \
          xargs clang-format-18 --dry-run --Werror

  cmake-format-check:
    name: CMake Format Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gersemi
        run: pip3 install gersemi

      - name: Check CMake Formatting
        continue-on-error: true  # Allow formatting differences due to tool versions
        run: |
          find . -name 'CMakeLists.txt' -o -name '*.cmake' | \
          xargs gersemi --check

  clang-tidy:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy-18 \
            build-essential \
            cmake \
            libcurl4-openssl-dev \
            libjansson-dev \
            libobs-dev \
            ninja-build

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        continue-on-error: true  # Allow GCC-specific compiler flag warnings
        run: |
          find src -name '*.c' -o -name '*.cpp' | \
          xargs clang-tidy-18 -p build --warnings-as-errors=''

  cppcheck:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --suppress=unusedFunction \
            --suppress=constParameterPointer \
            --suppress=constVariablePointer \
            --error-exitcode=1 \
            --inline-suppr \
            -I src \
            src/

  shellcheck:
    name: Shell Script Analysis (shellcheck)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shellcheck
        run: |
          find . -name '*.sh' -type f \
            -not -path '*/build/*' \
            -not -path '*/build_*/*' \
            -not -path '*/.git/*' \
            -not -path '*/.deps/*' | \
          xargs -r shellcheck --severity=warning --exclude=SC2155

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip3 install yamllint

      - name: Run yamllint
        run: yamllint .github/workflows/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run markdownlint
        continue-on-error: true  # Allow markdown format differences
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: node_modules

  codespell:
    name: Spell Check
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run codespell
        uses: codespell-project/actions-codespell@master
        with:
          check_filenames: true
          skip: .git,*.png,*.jpg,*.svg,build,*.lock,*.html
          ignore_words_list: SectionIn
