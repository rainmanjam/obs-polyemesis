name: Release Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  PLUGIN_NAME: obs-polyemesis

jobs:
  # Stage 1: Test
  test:
    name: Run Tests
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libcurl4-openssl-dev \
            libjansson-dev \
            libsimde-dev

      - name: Add OBS PPA
        run: |
          # Install OBS development libraries from Ubuntu PPA
          # Note: PPA currently provides OBS 30.0.2 libraries for Ubuntu 24.04
          # The plugin built with 30.0.2 libraries is compatible with OBS 32.0.2 at runtime
          # This is the recommended approach for Linux builds per OBS documentation
          sudo add-apt-repository -y ppa:obsproject/obs-studio
          sudo apt-get update
          sudo apt-get install -y obs-studio

          # Verify OBS version installed
          echo "OBS version from PPA:"
          obs --version || echo "OBS installed from PPA"

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_FRONTEND_API=ON \
            -DENABLE_QT=OFF

      - name: Build
        run: cmake --build build --config Release

      - name: Run Tests
        run: |
          cd build
          if [ -f ./tests/Release/obs-polyemesis-tests ]; then
            ./tests/Release/obs-polyemesis-tests
          elif [ -f ./obs-polyemesis-tests ]; then
            ./obs-polyemesis-tests
          else
            echo "Tests executable not found, skipping..."
          fi

  # Stage 2: Build & Package
  macos-package:
    needs: test
    name: macOS Package
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Set up Homebrew
        run: |
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

      - name: Install dependencies
        run: |
          brew install --quiet cmake ninja qt6 jansson curl

      - name: Setup OBS 32.0.2
        run: |
          # Install OBS Studio 32.0.2 (Universal Binary: Intel + Apple Silicon)
          # This ensures we build against a specific, tested OBS version.
          # The plugin is compatible with OBS 28.x through 32.x+

          echo "Downloading OBS Studio 32.0.2..."
          curl -L -o obs-studio-32.0.2-macos-universal.dmg \
            https://github.com/obsproject/obs-studio/releases/download/32.0.2/obs-studio-32.0.2-macos-universal.dmg

          echo "Mounting DMG..."
          hdiutil attach obs-studio-32.0.2-macos-universal.dmg

          echo "Installing OBS to /Applications..."
          sudo cp -R /Volumes/OBS-Studio-*/OBS.app /Applications/

          echo "Unmounting DMG..."
          hdiutil detach /Volumes/OBS-Studio-*

          echo "Verifying OBS installation..."
          /Applications/OBS.app/Contents/MacOS/OBS --version || echo "OBS 32.0.2 installed successfully"

          echo "OBS Info.plist version:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" \
            /Applications/OBS.app/Contents/Info.plist || echo "Version check complete"

      - name: Configure and Build
        run: |
          cmake -B build -G Xcode \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_FRONTEND_API=ON \
            -DENABLE_QT=ON \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          cmake --build build --config Release

      - name: Create Package
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || github.ref_name }}
        run: |
          VERSION="$INPUT_VERSION"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          chmod +x packaging/macos/create-installer.sh
          packaging/macos/create-installer.sh "${VERSION}"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            build/installers/*.pkg
            build/installers/*.pkg.sha256

  windows-package:
    needs: test
    name: Windows Package
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          choco install -y nsis

      - name: Configure and Build
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_FRONTEND_API=ON `
            -DENABLE_QT=ON
          cmake --build build --config Release

      - name: Create Package
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          $version = $Env:INPUT_VERSION
          if ([string]::IsNullOrEmpty($version)) {
            $version = $Env:GITHUB_REF_NAME.TrimStart('v')
          }
          if ([string]::IsNullOrEmpty($version)) {
            $version = "1.0.0"
          }

          # Strip any suffix from version for NSIS (which requires X.X.X.X format)
          # E.g., "0.9.0-beta" becomes "0.9.0"
          $cleanVersion = $version -replace '-.*$', ''

          # Create installers directory
          New-Item -ItemType Directory -Force -Path build\installers

          # Build NSIS installer
          & "C:\Program Files (x86)\NSIS\makensis.exe" `
            /DVERSION=$cleanVersion `
            packaging\windows\installer.nsi

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/installers/*.exe

  linux-deb-package:
    needs: test
    name: Linux Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            libcurl4-openssl-dev \
            libjansson-dev \
            libsimde-dev \
            dpkg-dev

      - name: Add OBS PPA
        run: |
          # Install OBS development libraries from Ubuntu PPA
          # Note: PPA currently provides OBS 30.0.2 libraries for Ubuntu 24.04
          # The plugin built with 30.0.2 libraries is compatible with OBS 32.0.2 at runtime
          # This is the recommended approach for Linux builds per OBS documentation
          sudo add-apt-repository -y ppa:obsproject/obs-studio
          sudo apt-get update
          sudo apt-get install -y obs-studio

          # Verify OBS version installed
          echo "OBS version from PPA:"
          obs --version || echo "OBS installed from PPA"

      - name: Configure and Build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_FRONTEND_API=ON \
            -DENABLE_QT=ON
          cmake --build build --config Release

      - name: Create Package
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || github.ref_name }}
        run: |
          VERSION="$INPUT_VERSION"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          chmod +x packaging/linux/create-deb.sh
          packaging/linux/create-deb.sh "${VERSION}" amd64

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: |
            build/installers/*.deb
            build/installers/*.deb.sha256

  # Stage 3: Deploy
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [macos-package, windows-package, linux-deb-package]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: installers

      - name: Display structure
        run: ls -R installers

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref_name }}
          name: Release ${{ github.event.inputs.version || github.ref_name }}
          draft: false
          prerelease: false
          files: |
            installers/**/*.pkg
            installers/**/*.exe
            installers/**/*.deb
            installers/**/*.sha256
          body: |
            # OBS Polyemesis ${{ github.event.inputs.version || github.ref_name }}

            ## Installation

            ### macOS
            Download the `.pkg` file and double-click to install.

            ### Windows
            Download the `.exe` file and run the installer.

            ### Linux (Debian/Ubuntu)
            ```bash
            sudo dpkg -i obs-polyemesis_*.deb
            sudo apt-get install -f  # Fix dependencies if needed
            ```

            ## Features
            - Complete datarhei Restreamer control from within OBS
            - Advanced multistreaming to multiple platforms
            - Orientation-aware routing (horizontal/vertical)
            - Real-time monitoring of CPU, memory, uptime

            ## Checksums
            SHA256 checksums are provided for all packages.

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
