#!/bin/bash
# Pre-commit hook for OBS Polyemesis
# Runs validation checks before allowing commit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
RUN_BASH_SYNTAX=1
RUN_SHELLCHECK=1
RUN_BUILD_TEST=1
RUN_FORMAT_CHECK=1

# Track results
ERRORS=0
WARNINGS=0

# Helper functions
log_info() {
    echo -e "${GREEN}[PRE-COMMIT]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    ERRORS=$((ERRORS + 1))
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    WARNINGS=$((WARNINGS + 1))
}

log_section() {
    echo ""
    echo -e "${BLUE}▸ $1${NC}"
}

echo ""
echo "══════════════════════════════════════════════════════════════"
echo "  Pre-commit Validation"
echo "══════════════════════════════════════════════════════════════"

# ==========================================
# 1. Bash Syntax Check
# ==========================================
if [ $RUN_BASH_SYNTAX -eq 1 ]; then
    log_section "Checking Bash syntax..."

    # Get list of shell scripts being committed
    SHELL_SCRIPTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

    # Also check common shell scripts
    COMMON_SCRIPTS="install.sh uninstall.sh diagnose.sh"

    for script in $COMMON_SCRIPTS; do
        if [ -f "$script" ] && git diff --cached --name-only | grep -q "$script"; then
            SHELL_SCRIPTS="$SHELL_SCRIPTS $script"
        fi
    done

    if [ -z "$SHELL_SCRIPTS" ]; then
        log_info "No shell scripts to check"
    else
        for script in $SHELL_SCRIPTS; do
            if [ -f "$script" ]; then
                echo "  Checking $script..."
                if ! bash -n "$script" 2>&1; then
                    log_error "Syntax error in $script"
                else
                    echo "    ✓ OK"
                fi
            fi
        done
    fi
fi

# ==========================================
# 2. ShellCheck Linting
# ==========================================
if [ $RUN_SHELLCHECK -eq 1 ]; then
    log_section "Running ShellCheck..."

    if ! command -v shellcheck &> /dev/null; then
        log_warn "shellcheck not installed (install with: brew install shellcheck)"
        log_info "Skipping shellcheck validation"
    else
        # Get list of shell scripts being committed
        SHELL_SCRIPTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

        if [ -z "$SHELL_SCRIPTS" ]; then
            log_info "No shell scripts to lint"
        else
            for script in $SHELL_SCRIPTS; do
                if [ -f "$script" ]; then
                    echo "  Linting $script..."
                    if shellcheck -x "$script" 2>&1 | head -20; then
                        echo "    ✓ OK"
                    else
                        log_warn "ShellCheck found issues in $script (not blocking)"
                    fi
                fi
            done
        fi
    fi
fi

# ==========================================
# 3. Code Formatting Check
# ==========================================
if [ $RUN_FORMAT_CHECK -eq 1 ]; then
    log_section "Checking code formatting..."

    # Check for trailing whitespace in source files
    echo "  Checking for trailing whitespace..."
    TRAILING_WHITESPACE=$(git diff --cached --check -- '*.c' '*.cpp' '*.h' '*.sh' 2>&1 | grep 'trailing whitespace' || true)

    if [ -n "$TRAILING_WHITESPACE" ]; then
        log_error "Found trailing whitespace:"
        echo "$TRAILING_WHITESPACE" | sed 's/^/    /'
        echo ""
        log_info "Fix with: git diff --cached | sed 's/[[:space:]]*$//' | git apply"
    else
        log_info "✓ No trailing whitespace found"
    fi

    # Check for tabs in source files (except Makefiles)
    echo "  Checking for tabs in source files..."
    FILES_WITH_TABS=$(git diff --cached --name-only --diff-filter=ACM | \
        grep -E '\.(c|cpp|h|sh)$' | \
        xargs grep -l $'\t' 2>/dev/null || true)

    if [ -n "$FILES_WITH_TABS" ]; then
        log_warn "Found tabs in source files:"
        echo "$FILES_WITH_TABS" | sed 's/^/    /'
    else
        log_info "✓ No tabs in source files"
    fi

    # Check line endings (should be LF, not CRLF)
    echo "  Checking line endings..."
    FILES_WITH_CRLF=$(git diff --cached --name-only --diff-filter=ACM | \
        xargs file 2>/dev/null | \
        grep CRLF | \
        cut -d: -f1 || true)

    if [ -n "$FILES_WITH_CRLF" ]; then
        log_error "Found CRLF line endings (should be LF):"
        echo "$FILES_WITH_CRLF" | sed 's/^/    /'
        echo ""
        log_info "Fix with: dos2unix <file> or configure git: git config core.autocrlf input"
    else
        log_info "✓ All files have LF line endings"
    fi
fi

# ==========================================
# 4. Quick Build Test
# ==========================================
if [ $RUN_BUILD_TEST -eq 1 ]; then
    log_section "Running quick build test..."

    # Check if source files were modified
    SOURCE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|h)$' || true)

    if [ -z "$SOURCE_FILES" ]; then
        log_info "No source files modified, skipping build test"
    else
        log_info "Source files modified, running quick build test..."

        # Only test if we have a build directory already (don't force full build)
        if [ -d "build" ]; then
            echo "  Testing build..."
            if BUILD_DIR=build cmake --build build --config Release --target obs-polyemesis 2>&1 | tail -20; then
                log_info "✓ Quick build test passed"
            else
                log_error "Build test failed"
                log_info "Fix build errors before committing"
            fi
        else
            log_warn "No build directory found, skipping build test"
            log_info "Run 'make build' to create build directory"
        fi
    fi
fi

# ==========================================
# Summary
# ==========================================
echo ""
echo "══════════════════════════════════════════════════════════════"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}✗ Pre-commit validation failed with $ERRORS error(s)${NC}"
    echo ""
    log_info "Fix the errors above and try again"
    echo ""
    log_info "To bypass pre-commit hooks (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}⚠ Pre-commit validation passed with $WARNINGS warning(s)${NC}"
    echo ""
    log_info "Consider addressing the warnings above"
    echo ""
    exit 0
else
    echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
fi
