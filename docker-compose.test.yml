version: '3.8'

services:
  restreamer:
    image: datarhei/restreamer:latest
    container_name: restreamer-test
    ports:
      - "8080:8080"
      - "8181:8181"
      - "1935:1935"
      - "6000:6000/udp"
    environment:
      # Core configuration
      CORE_LOG_LEVEL: "info"
      CORE_LOG_TOPICS: "app,http,rtmp,srt"

      # API configuration
      CORE_API_AUTH_ENABLE: "true"
      CORE_API_AUTH_USERNAME: "admin"
      CORE_API_AUTH_PASSWORD: "datarhei"
      CORE_API_AUTH_JWT_SECRET: "test-secret-key-for-jwt-tokens"

      # Storage configuration
      CORE_STORAGE_DISK_DIR: "/core/data"
      CORE_STORAGE_DISK_MAX_SIZE_MBYTES: "10000"

      # FFmpeg configuration
      FFMPEG_LOG_LEVEL: "info"
      FFMPEG_BINARY: "/usr/local/bin/ffmpeg"

      # RTMP configuration
      RTMP_ENABLE: "true"
      RTMP_ENABLE_PUSH: "true"

      # SRT configuration
      SRT_ENABLE: "true"

      # Session configuration
      CORE_DB_DIR: "/core/config"

      # Process limits
      CORE_PROCESS_FFMPEG_MAX_PROCESSES: "10"
      CORE_PROCESS_FFMPEG_ACCESS_INPUT_ALLOW: ".*"
      CORE_PROCESS_FFMPEG_ACCESS_OUTPUT_ALLOW: ".*"

    volumes:
      - restreamer-data:/core/data
      - restreamer-config:/core/config

    networks:
      - restreamer-test-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v3/about"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    restart: unless-stopped

  # Test media server for input sources
  nginx-media:
    image: nginx:alpine
    container_name: nginx-media-test
    ports:
      - "8888:80"
    volumes:
      - ./tests/fixtures/media:/usr/share/nginx/html:ro
    networks:
      - restreamer-test-net

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  restreamer-data:
    driver: local
  restreamer-config:
    driver: local

networks:
  restreamer-test-net:
    driver: bridge
