version: '3.8'

services:
  restreamer:
    image: datarhei/restreamer:latest
    container_name: restreamer-e2e-test
    ports:
      - "8080:8080"   # HTTP API
      - "8181:8181"   # HTTPS API
      - "1935:1935"   # RTMP
      - "6000:6000/udp" # SRT
    environment:
      # API Configuration
      - CORE_API_AUTH_ENABLE=true
      - CORE_API_AUTH_USERNAME=admin
      - CORE_API_AUTH_PASSWORD=test-password-e2e
      - CORE_API_AUTH_JWT_SECRET=test-jwt-secret-for-e2e-testing

      # Storage
      - CORE_STORAGE_DISK_DIR=/core/data
      - CORE_STORAGE_DISK_SIZE=10737418240  # 10GB

      # Logging
      - CORE_LOG_LEVEL=info
      - CORE_LOG_TOPICS=all

      # Database
      - CORE_DB_DIR=/core/config

      # CORS (allow all for testing)
      - CORE_API_ACCESS_HTTP_ALLOW_ORIGIN=*

    volumes:
      - restreamer-data:/core/data
      - restreamer-config:/core/config

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v3/about"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 10s

    networks:
      - e2e-test-network

volumes:
  restreamer-data:
    driver: local
  restreamer-config:
    driver: local

networks:
  e2e-test-network:
    driver: bridge
